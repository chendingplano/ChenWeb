var O=new Date().valueOf(),j=()=>O++;function V(o,e){if(Object.keys(o).length!==Object.keys(e).length)return!1;for(const n in e){const t=o[n],s=e[n];if(!b(t,s))return!1}return!0}function b(o,e){if(typeof o=="number"||typeof o=="string"||typeof o=="boolean"||o===null)return o===e;if(typeof o!=typeof e||(o===null||e===null)&&o!==e||o instanceof Date&&e instanceof Date&&o.getTime()!==e.getTime())return!1;if(typeof o=="object")if(Array.isArray(o)&&Array.isArray(e)){if(o.length!==e.length)return!1;for(let n=o.length-1;n>=0;n--)if(!b(o[n],e[n]))return!1;return!0}else return V(o,e);return o===e}function R(o){if(typeof o!="object"||o===null)return o;if(o instanceof Date)return new Date(o);if(o instanceof Array)return o.map(R);const e={};for(const n in o)e[n]=R(o[n]);return e}var I=2,W=class{constructor(o){o&&(this._writable=o.writable,this._async=o.async),this._values={},this._state={}}setState(o,e=0){const n={};return this._wrapProperties(o,this._state,this._values,"",n,e),n}getState(){return this._values}getReactive(){return this._state}_wrapProperties(o,e,n,t,s,i){for(const a in o){const r=e[a],c=n[a],l=o[a];if(r&&(c===l&&typeof l!="object"||l instanceof Date&&c instanceof Date&&c.getTime()===l.getTime()))continue;const d=t+(t?".":"")+a;r?(r.__parse(l,d,s,i)&&(n[a]=l),i&I?s[d]=r.__trigger:r.__trigger()):(l&&l.__reactive?e[a]=this._wrapNested(l,l,d,s):e[a]=this._wrapWritable(l),n[a]=l),s[d]=s[d]||null}}_wrapNested(o,e,n,t){const s=this._wrapWritable(o);return this._wrapProperties(o,s,e,n,t,0),s.__parse=(i,a,r,c)=>(this._wrapProperties(i,s,e,a,r,c),!1),s}_wrapWritable(o){const e=[],n=function(){for(let t=0;t<e.length;t++)e[t](o)};return{subscribe:t=>(e.push(t),this._async?setTimeout(t,1,o):t(o),()=>{const s=e.indexOf(t);s>=0&&e.splice(s,1)}),__trigger:()=>{e.length&&(this._async?setTimeout(n,1):n())},__parse:function(t){return o=t,!0}}}},F=class{constructor(o,e,n,t){typeof o=="function"?this._setter=o:this._setter=o.setState.bind(o),this._routes=e,this._parsers=n,this._prev={},this._triggers=new Map,this._sources=new Map,this._routes.forEach(s=>{s.in.forEach(i=>{const a=this._triggers.get(i)||[];a.push(s),this._triggers.set(i,a)}),s.out.forEach(i=>{const a=this._sources.get(i)||{};s.in.forEach(r=>a[r]=!0),this._sources.set(i,a)})}),this._routes.forEach(s=>{s.length=Math.max(...s.in.map(i=>T(i,this._sources,1)))}),this._bus=t}init(o){const e={};for(const n in o)if(this._prev[n]!==o[n]){const t=this._parsers[n];e[n]=t?t(o[n]):o[n]}this._prev=this._prev?{...this._prev,...o}:{...o},this.setState(e),this._bus&&this._bus.exec("init-state",e)}setStateAsync(o){const e=this._setter(o,I);return this._async?Object.assign(this._async.signals,e):this._async={signals:e,timer:setTimeout(this._applyState.bind(this),1)},e}_applyState(){const o=this._async;if(o){this._async=null,this._triggerUpdates(o.signals,[]);for(const e in o.signals){const n=o.signals[e];n&&n()}}}setState(o,e=[]){const n=this._setter(o);return this._triggerUpdates(n,e),n}_triggerUpdates(o,e){const n=Object.keys(o),t=!e.length;e=e||[];for(let s=0;s<n.length;s++){const i=n[s],a=this._triggers.get(i);a&&a.forEach(r=>{e.indexOf(r)==-1&&e.push(r)})}t&&this._execNext(e)}_execNext(o){for(;o.length;){o.sort((n,t)=>n.length<t.length?1:-1);const e=o[o.length-1];o.splice(o.length-1),e.exec(o)}}};function T(o,e,n){const t=e.get(o);if(!t)return n;const s=Object.keys(t).map(i=>T(i,e,n+1));return Math.max(...s)}var U=class{constructor(){this._nextHandler=null,this._handlers={},this._tag=new WeakMap,this.exec=this.exec.bind(this)}on(o,e,n){let t=this._handlers[o];t?n&&n.intercept?t.unshift(e):t.push(e):t=this._handlers[o]=[e],n&&n.tag&&this._tag.set(e,n.tag)}intercept(o,e,n){this.on(o,e,{...n,intercept:!0})}detach(o){for(const e in this._handlers){const n=this._handlers[e];for(let t=n.length-1;t>=0;t--)this._tag.get(n[t])===o&&n.splice(t,1)}}async exec(o,e){const n=this._handlers[o];if(n)for(let t=0;t<n.length;t++){const s=n[t](e);if(s===!1||s&&s.then&&await s===!1)return}return this._nextHandler&&await this._nextHandler.exec(o,e),e}setNext(o){return this._nextHandler=o}};function B(o){return e=>e[o]}function K(o){return(e,n)=>e[o]=n}function S(o,e){return(e.getter||B(e.id))(o)}function H(o,e,n){return(e.setter||K(e.id))(o,n)}function X(o){return o.filter(e=>!!e.editor).map(e=>{let n={key:e.id||j(),label:e.header};e.options&&(n.options=e.options);let t=e.editor;return typeof t=="function"&&(t=t()),typeof t=="object"?(n={...n,...t},n.comp=t.type):n.comp=t,n})}function D(o,e){const n=document.createElement("a");n.href=URL.createObjectURL(o),n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n)}function v(o,e){let n=S(o,e)??"";return e.template&&(n=e.template(n,o,e)),e.optionsMap&&(Array.isArray(n)?n=n.map(t=>e.optionsMap.get(t)):n=e.optionsMap.get(n)),typeof n>"u"?"":n+""}function q(o,e){const n=/\n|"|;|,/;let t="";const s=e.rows||`
`,i=e.cols||"	",a=o._columns,r=o.flatData;e.header!==!1&&a[0].header&&(t=M("header",a,t,i,s));for(let c=0;c<r.length;c++){const l=[];for(let d=0;d<a.length;d++){let h=v(r[c],a[d]);n.test(h)&&(h='"'+h.replace(/"/g,'""')+'"'),l.push(h)}t+=(t?s:"")+l.join(i)}return e.footer!==!1&&a[0].footer&&(t=M("footer",a,t,i,s)),t}function M(o,e,n,t,s){const i=/\n|"|;|,/;for(let a=0;a<e[0][o].length;a++){const r=[];for(let c=0;c<e.length;c++){let l=(e[c][o][a].text||"")+"";i.test(l)&&(l='"'+l.replace(/"/g,'""')+'"'),r.push(l)}n+=(n?s:"")+r.join(t)}return n}function G(o,e,n){const t=[],s=[],i=[];let a=[];const r=o._columns,c=o.flatData,l=o._sizes;for(const h of r)i.push({width:h.flexgrow?l.columnWidth:h.width});let d=0;e.header!==!1&&r[0].header&&(P("header",r,t,s,d,e,n),a=a.concat(l.headerRowHeights.map(h=>({height:h}))),d+=r[0].header.length);for(let h=0;h<c.length;h++){const u=[];for(let f=0;f<r.length;f++){const g=c[h],p=r[f],w=S(g,p)??"";let m=v(g,p),x;e.cellStyle&&(x=e.cellStyle(w,g,p)),e.cellTemplate&&(m=e.cellTemplate(w,g,p)??m);const _=z(m,2,x,n);u.push(_)}t.push(u),a.push({height:l.rowHeight})}return d+=c.length,e.footer!==!1&&r[0].footer&&(P("footer",r,t,s,d,e,n),a=a.concat(l.footerRowHeights.map(h=>({height:h})))),{cells:t,merged:s,rowSizes:a,colSizes:i,styles:n}}function P(o,e,n,t,s,i,a){for(let r=0;r<e[0][o].length;r++){const c=[];for(let l=0;l<e.length;l++){const d=e[l][o][r],h=d.colspan?d.colspan-1:0,u=d.rowspan?d.rowspan-1:0;(h||u)&&t.push({from:{row:r+s,column:l},to:{row:r+s+u,column:l+h}});let f=d.text??"",g;i.headerCellStyle&&(g=i.headerCellStyle(f,d,e[l],o)),i.headerCellTemplate&&(f=i.headerCellTemplate(f,d,e[l],o)??f);let p;o=="header"?r==e[0][o].length-1?p=1:p=0:r?p=4:p=3;const w=z(f,p,g,a);c.push(w)}n.push(c)}}function z(o,e,n,t){let s=e;if(o&&o instanceof Date&&(o=Q(o),n=n||{},n.format=n.format||"dd/mm/yyyy"),n){n={...t[e],...n};const i=t.findIndex(a=>b(a,n));i<0?(t.push(n),s=t.length-1):s=i}return{v:o+"",s}}function J(o){const e={material:"#000000",willow:"#000000","willow-dark":"#ffffff"},n={material:"none",willow:"none","willow-dark":"#2a2b2d"},t={material:"#fafafb",willow:"#f2f3f7","willow-dark":"#20262b"},s={material:"0.5px solid #dfdfdf",willow:"0.5px solid #e6e6e6","willow-dark":"0.5px solid #384047"},i={material:"#dfdfdf",willow:"#e6e6e6","willow-dark":"#384047"},a=e[o],r="0.5px solid "+i[o],c={verticalAlign:"center",align:"left"},l={fontWeight:"bold",color:a,background:t[o],...c,borderBottom:r,borderRight:r};return{cell:{color:a,background:n[o],borderBottom:s[o],borderRight:s[o],...c},header:{...l},footer:{...l}}}function Q(o){return o?25569+(o.getTime()-o.getTimezoneOffset()*6e4)/(86400*1e3):null}const Y="portrait",Z=100,ee="a4",te={a3:{width:11.7,height:16.5},a4:{width:8.27,height:11.7},letter:{width:8.5,height:11}};function se(o,e){const n=[];let t=[],s=0;const i=o.filter(r=>!r.hidden),a=ie(e);return i.forEach((r,c)=>{s+r.width<=a?(s+=r.width,t.push(r)):(t.length&&n.push(t),t=[r],s=r.width),c===i.length-1&&t.length&&n.push(t)}),n}function ne(o,e,n){const t=[];return o.forEach((s,i)=>{const a=s[e];for(let r=0;r<n.length;r++){t[r]||(t[r]=[]);const c={...a[r]};if(t[r][i]!==null){if(!i&&!c.rowspan&&!c.colspan){let l=1,d=o[i+l][e][r],h=c.width;for(;!d.rowspan&&!d.colspan;)l++,d=o[i+l][e][r],h+=d.width;c.colspan=l,c.width=h,c.height=n[r]}if(t[r].push(c),!c.collapsed&&c.colspan>1){let l=c.colspan-1;if(c.colspan+i>o.length){const d=c.colspan-(c.colspan+i-o.length);c.colspan=d,c.width=o.slice(i,i+l+1).reduce((h,u)=>h+u.width,0),d>1&&(l=d-1)}for(let d=0;d<l;d++)t[r].push(null)}if(c.rowspan>1){const l=c.rowspan;for(let d=1;d<l;d++)t[r+d]||(t[r+d]=[]),t[r+d].push(null)}}}if(s.collapsed)for(let r=0;r<t.length;r++){const c=t[r],l=c[i];if(l&&l.collapsed){if(c[i]=null,!r)break}else{const d=l||c.findLast(h=>h?.colspan>=1);d&&(d.colspan=d.colspan-1,d.width=d.width-s.width)}}}),t.map(s=>s.filter(i=>i&&i.colspan!==0))}function ie(o){const{mode:e,ppi:n,paper:t}=o,{width:s,height:i}=te[t];return oe(e==="portrait"?s:i,n)}function oe(o,e){return o*e}function re(o={}){const{mode:e,ppi:n,paper:t}=o;return{mode:e||Y,ppi:n||Z,paper:t||ee}}function ae(o,e){return o.flexgrow?`min-width:${e}px;width:auto`:`width:${o.width}px; max-width:${o.width}px; height:${o.height}px`}function le(o,e,n){let t=o[n.id];if(n.filter.type==="richselect"&&t){const s=n.filter.config?.options||e.find(({id:i})=>i==n.id).options;s&&(t=s.find(({id:i})=>i==t).label)}return t??""}const $=["resize-column","hide-column","update-cell"],ce=["delete-row","update-row","update-cell"],de=["move-item"],he=["resize-column","move-item"];class ue{undo=[];redo=[];progress={};in;getState;setState;_previousValues={};constructor(e,n,t){this.in=e,this.getState=n,this.setState=t,this.setHandlers(),this.resetStateHistory()}getHandlers(){return{"add-row":{handler:e=>({action:"delete-row",data:{id:e.id},source:{action:"add-row",data:e}})},"delete-row":{handler:e=>{const{id:n}=e,{data:t}=this.getPrev(),s=t.findIndex(i=>i.id==n);return{action:"add-row",data:{id:n,row:t[s],before:s<t.length-1?t[s+1].id:void 0},source:{action:"delete-row",data:e}}}},"update-cell":{handler:e=>{const{id:n,column:t}=e,s=this.getRow(n),i=this.getColumn(t),a=S(s,i);return b(a,e.value)?null:{action:"update-cell",data:{id:n,column:t,value:a},source:{action:"update-cell",data:e}}}},"update-row":{handler:e=>{const{id:n}=e,t=this.getRow(n);return{action:"update-row",data:{id:n,row:t},source:{action:"update-row",data:e}}}},"resize-column":{handler:e=>{const{id:n,width:t}=e,s=this.getColumn(n),{_sizes:i}=this.getState();return{action:"resize-column",data:{id:n,width:s.width??i.columnWidth},source:{action:"resize-column",data:{id:n,width:t}}}}},"hide-column":{handler:e=>{const{id:n}=e,t=this.getColumn(n);return{action:"hide-column",data:{id:n,mode:t.hidden},source:{action:"hide-column",data:e}}}},"collapse-column":{handler:e=>{const{id:n,row:t,mode:s}=e;return{action:"collapse-column",data:{id:n,row:t,mode:typeof s=="boolean"?!s:s},source:{action:"collapse-column",data:e}}}},"move-item":{handler:e=>{const{id:n,target:t,mode:s}=e,{flatData:i}=this.getPrev(),a=i.findIndex(r=>r.id==n);return{action:"move-item",data:{id:n,target:i[a+(a?-1:1)].id,mode:a?"after":"before"},source:{action:"move-item",data:{id:n,target:t,mode:s}}}}},"open-row":{handler:e=>{const{id:n,nested:t}=e;return{action:"close-row",data:{id:n,nested:t},source:{action:"open-row",data:e}}}},"close-row":{handler:e=>{const{id:n,nested:t}=e;return{action:"open-row",data:{id:n,nested:t},source:{action:"close-row",data:e}}}}}}resetHistory(){this.undo=[],this.redo=[],this.progress={},this.resetStateHistory()}getPrev(){return this._previousValues}setHandlers(){const e=this.getHandlers();for(const n in e)this.in.intercept(n,t=>{if(!(t.eventSource==="undo"||t.eventSource==="redo"||t.skipUndo)){if(he.includes(n)){(t.inProgress&&!this.progress[n]||typeof t.inProgress!="boolean")&&(de.includes(n)&&this.setPrev("flatData"),$.includes(n)&&this.setPrev("columns")),this.progress[n]=t.inProgress;return}ce.includes(n)&&this.setPrev("data"),$.includes(n)&&this.setPrev("columns")}}),this.in.on(n,t=>{if(t.eventSource==="undo"||t.eventSource==="redo"||t.skipUndo||t.inProgress)return;const s=e[n].handler(t);s&&this.addToHistory(s)})}setPrev(e){this._previousValues[e]=R(this.getState()[e])}addToHistory(e){this.undo.push(e),this.redo=[],this.setStateHistory()}handleUndo(){if(!this.undo.length)return;const e=this.undo.pop();this.redo.push({...e.source,source:e}),this.in.exec(e.action,{...e.data,eventSource:"undo"}),this.setStateHistory()}handleRedo(){if(!this.redo.length)return;const e=this.redo.pop();this.undo.push({...e.source,source:e}),this.in.exec(e.action,{...e.data,eventSource:"redo"}),this.setStateHistory()}resetStateHistory(){this.setState({history:{undo:0,redo:0}})}setStateHistory(){this.setState({history:{undo:this.undo.length,redo:this.redo.length}})}getRow(e){const{data:n}=this.getPrev();return this.getState().tree?this.getTreeRow(n,e):n.find(t=>t.id==e)}getTreeRow(e,n){for(let t=0;t<e.length;t++){if(e[t].id==n)return e[t];if(e[t].data){const s=this.getTreeRow(e[t].data,n);if(s)return s}}return null}getColumn(e){const{columns:n}=this.getPrev();return n.find(t=>t.id==e)}}function fe(){return{gen:1}}function A(){let o=!0;return o=!1,o}function N(o,e){return typeof o>"u"||o===null?-1:typeof e>"u"||e===null?1:o===e?0:o>e?1:-1}function ge(o,e){return-N(o,e)}function pe(o,e){const n=o==="asc"?N:ge;return function(t,s){return n(S(t,e),S(s,e))}}function we(o,e){if(!o||!o.length)return;const n=o.map(t=>pe(t.order,e.find(s=>s.id==t.key)));return o.length===1?n[0]:function(t,s){for(let i=0;i<n.length;i++){const a=n[i](t,s);if(a!==0)return a}return 0}}const k=28,me=20;function xe(){if(typeof document>"u")return"willow";const o=document.querySelector('[class^="wx"][class$="theme"]');return o?o.className.substring(3,o.className.length-6):"willow"}function C(o,e,n,t,s){const i=document.createElement("div"),a=document.createElement("div"),r=document.body;s=s?`${s}px`:"auto";let c,l;a.className=e,i.classList.add(`wx-${n}-theme`),i.style.cssText=`height:auto;position:absolute;top:0px;left:100px;overflow:hidden;width=${s};white-space:nowrap;`,i.appendChild(a),r.appendChild(i),typeof o!="object"&&(o=[o]);for(let d=0;d<o.length;d++){a.innerText=o[d]+"";const h=i.getBoundingClientRect(),u=Math.ceil(h.width)+(t&&t.length?t[d]:0),f=Math.ceil(h.height);c=Math.max(c||0,u),l=Math.max(l||0,f)}return i.remove(),{width:c,height:l}}function L(o,e,n,t,s){const i=[];for(let a=0;a<o.length;a++){const r=o[a][e],c=r.length;for(let l=0;l<c;l++){const{text:d,vertical:h,collapsed:u,rowspan:f,css:g}=r[l];if(!d){i[l]=Math.max(i[l]||0,t);continue}let p=0;if(h&&!u){let w=`wx-measure-cell-${e}`;if(w+=g?` ${g}`:"",p=C(d,w,s).width,(f>1||!r[l+1])&&n>l+1){const m=f||n-l,x=i.slice(l,l+m).reduce((_,y)=>_+y,0);if(x<p){const _=Math.ceil((p-x)/m);for(let y=l;y<l+m;y++)i[y]=(i[y]||t)+_}continue}}i[l]=Math.max(i[l]||t,p)}}return i}function ye(o,e,n){const t=[],s=[];let i="wx-measure-cell-body";i+=o.css?` ${o.css}`:"";for(let a=0;a<e.length;a++){const r=e[a],c=v(r,o);c&&(t.push(c),o.treetoggle?s.push(e[a].$level*k+(e[a].$count?k:0)+(o.draggable?k:0)):o.draggable&&s.push(k))}return C(t,i,n,s).width}function _e(o,e){const n="wx-measure-cell-header",t=o.sort?me:0;let s=o.header;if(typeof s=="string")return C(s,n,e).width+t;let i;Array.isArray(s)||(s=[s]);for(let a=0;a<s.length;a++){const r=s[a],c=typeof r=="string"?r:r.text,l=n+(typeof r=="string"?"":` ${r.css}`);let d=C(c,l,e).width;a===s.length-1&&(d+=t),i=Math.max(i||0,d)}return i}const Se={text:(o,e)=>o?o.toLowerCase().indexOf(e.toLowerCase())!==-1:!e,richselect:(o,e)=>typeof e!="number"&&!e?!0:o==e};function be(o){return Se[o]}class ve extends W{in;_router;_branches;_xlsxWorker;_historyManager;constructor(e){super({writable:e,async:!1});const n={rowHeight:37,columnWidth:160,headerHeight:36,footerHeight:36};this._router=new F(super.setState.bind(this),[{in:["columns","sizes","_skin"],out:["_columns","_sizes"],exec:s=>{const{columns:i,sizes:a,_skin:r}=this.getState(),c=this.copyColumns(i),l=c.reduce((u,f)=>Math.max(f.header.length,u),0),d=c.reduce((u,f)=>Math.max(f.footer.length,u),0);c.forEach(this.setCollapsibleColumns);const h=this.normalizeSizes(c,a,l,d,r);c.forEach((u,f)=>{this.normalizeColumns(c,f,"header",l,h),this.normalizeColumns(c,f,"footer",d,h)}),this.setState({_columns:c,_sizes:h},s)}},{in:["data","tree","_filterIds"],out:["flatData"],exec:s=>{const{data:i,tree:a,_filterIds:r}=this.getState(),c=a?this.flattenRows(i,[],r):i.filter(l=>!r||r.includes(l.id));this.setState({flatData:c},s)}}],{sizes:s=>({...n,...s})});const t=this.in=new U;t.on("close-editor",({ignore:s})=>{const{editor:i}=this.getState();i&&(s||t.exec("update-cell",i),this.setState({editor:null}))}),t.on("open-editor",({id:s,column:i})=>{let a=this.getState().editor;a&&t.exec("close-editor",{});const r=this.getRow(s),c=i?this.getColumn(i):this.getNextEditor(r);if(c?.editor){let l=c.editor;if(typeof l=="function"&&(l=l(r,c)),!l)return;a={column:c.id,id:s,value:S(r,c)??"",renderedValue:v(r,c)},typeof l=="object"&&l.config&&(a.config=l.config,l.config.options&&(a.options=l.config.options)),c.options&&!a.options&&(a.options=c.options),this.setState({editor:a})}}),t.on("editor",({value:s})=>{const i=this.getState().editor;i&&(i.value=s,this.setState({editor:i}))}),t.on("add-row",s=>{const i=this.getState();let{data:a}=i;const{select:r,_filterIds:c}=i,{row:l,before:d,after:h,select:u}=s;if(s.id=l.id=s.id||l.id||E(),d||h){const g=d||h,p=a.findIndex(w=>w.id===g);a.splice(p+(h?1:0),0,s.row),a=[...a]}else a=[...a,s.row];const f={data:a};c&&(f._filterIds=[...c,s.id]),this.setState(f),!(typeof u=="boolean"&&!u)&&(u||r)&&t.exec("select-row",{id:l.id,show:!0})}),t.on("delete-row",s=>{const{data:i,selectedRows:a,focusCell:r}=this.getState(),{id:c}=s,l={data:i.filter(d=>d.id!==c)};this.isSelected(c)&&(l.selectedRows=a.filter(d=>d!==c)),this.setState(l),r?.row===c&&this.in.exec("focus-cell",{eventSource:"delete-row"})}),t.on("update-cell",s=>{const i=this.getState();let{data:a}=i;a=[...a];const{tree:r}=i,{id:c,column:l,value:d}=s,h=this.getColumn(l);if(r){const u={...this._branches[c]};H(u,h,d);const f=this.updateTreeRow(u);u.$parent===0&&(a=f)}else{const u=a.findIndex(g=>g.id==c),f={...a[u]};H(f,h,d),a[u]=f}this.setState({data:a})}),t.on("update-row",s=>{let{data:i}=this.getState();const{id:a,row:r}=s,c=i.findIndex(l=>l.id==a);i=[...i],i[c]={...i[c],...r},this.setState({data:i})}),t.on("select-row",({id:s,toggle:i,range:a,mode:r,show:c,column:l})=>{const d=this.getState(),{focusCell:h}=d;let{selectedRows:u}=d;if(u.length||(a=i=!1),a){const{data:f}=this.getState();let g=f.findIndex(w=>w.id==u[u.length-1]),p=f.findIndex(w=>w.id==s);g>p&&([g,p]=[p,g]),f.slice(g,p+1).forEach(w=>{u.indexOf(w.id)===-1&&u.push(w.id)})}else if(i&&this.isSelected(s)){if(r===!0)return;u=u.filter(f=>f!==s)}else if(i){if(r===!1)return;u.push(s)}else u=[s];this.setState({selectedRows:u}),h?.row!==s&&this.in.exec("focus-cell",{eventSource:"select-row"}),c&&this.in.exec("scroll",{row:s,column:l})}),this.in.on("focus-cell",s=>{const{row:i,column:a,eventSource:r}=s,{_columns:c,split:l}=this.getState();i&&a?(this.setState({focusCell:{row:i,column:a}}),r!=="click"&&((!l.left||c.findIndex(d=>d.id==s.column)>=l.left)&&(!l.right||c.findIndex(d=>d.id==s.column)<c.length-l.right)?this.in.exec("scroll",{row:i,column:a}):this.in.exec("scroll",{row:i}))):this.setState({focusCell:null})}),t.on("resize-column",s=>{const{id:i,auto:a,maxRows:r,inProgress:c}=s;if(c===!1)return;let l=s.width||0;const d=[...this.getState().columns],h=d.find(u=>u.id==i);if(a){if(a=="data"||a===!0){const{flatData:u,_skin:f}=this.getState();let g=u.length;r&&(g=Math.min(r,g));const p=u.slice(0,g);l=ye(h,p,f)}if(a=="header"||a===!0){const{_skin:u}=this.getState();l=Math.max(_e(h,u),l)}}h.width=Math.max(17,l),delete h.flexgrow,this.setState({columns:d})}),t.on("hide-column",s=>{const{id:i,mode:a}=s,r=[...this.getState().columns],c=r.find(d=>d.id==i),l=r.reduce((d,h)=>d+(h.hidden?0:1),0);!a||l>1?(c.hidden=!c.hidden,this.setState({columns:r})):s.skipUndo=!0}),t.on("sort-rows",s=>{const{key:i,add:a}=s;let{order:r="asc"}=s;const c=this.getState();let l=c.sortMarks;const{columns:d,data:h,tree:u}=c,f=Object.keys(l),g=f.length;l[i]&&(r=l[i].order==="asc"?"desc":"asc"),!a||!g||g===1&&l[i]?l={[i]:{order:r}}:(g===1&&(l[f[0]]={...l[f[0]],index:0}),l={...l,[i]:{order:r,index:l[i]?.index??g}});const p=Object.keys(l).sort((m,x)=>l[m].index-l[x].index).map(m=>({key:m,order:l[m].order}));this.setState({sortMarks:l});const w=we(p,d);if(w){const m=[...h];u?this.sortTree(m,w):m.sort(w),this.setState({data:m})}}),t.on("filter-rows",s=>{const{value:i,key:a,filter:r}=s;if(!Object.keys(s).length){this.setState({filterValues:{},_filterIds:null});return}const c=this.getState(),{data:l,tree:d}=c;let h=c.filterValues;const u={};a&&(h={...h,[a]:i},u.filterValues=h);const f=r??this.createFilter(h);let g=[];d?g=this.filterTree(l,f,g):l.forEach(p=>{f(p)&&g.push(p.id)}),u._filterIds=g,this.setState(u)}),t.on("collapse-column",s=>{const{id:i,row:a,mode:r}=s,c=[...this.getState().columns],l=this.getColumn(i).header,d=Array.isArray(l)?l[a]:l;typeof d=="object"&&(d.collapsed=r??!d.collapsed,this.setState({columns:c}))}),t.on("move-item",s=>{const{id:i,target:a,mode:r="after",inProgress:c}=s,{data:l,flatData:d,tree:h}=this.getState(),u=d.findIndex(p=>p.id==i),f=d.findIndex(p=>p.id==a);if(u===-1||f===-1||c===!1)return;let g;h?g=this.moveItem(i,a,l,r):g=this.moveItem(i,a,l,r),this.setState({data:h?this.normalizeTreeRows(g):g})}),t.on("open-row",s=>{const{id:i,nested:a}=s;this.toggleBranch(i,!0,a)}),t.on("close-row",s=>{const{id:i,nested:a}=s;this.toggleBranch(i,!1,a)}),t.on("export",s=>new Promise((i,a)=>{const r=s.options||{},c=`${r.fileName||"data"}.${r.format}`;if(r.format=="csv"){const l=q(this.getState(),r);r.download!==!1?D(new Blob(["\uFEFF"+l],{type:"text/csv"}),c):s.result=l,i(!0)}else if(r.format=="xlsx"){let l=r.styles;!l&&l!==!1&&(l=J(this.getState()._skin));const d=l,h=d?[{...d.header},{...d.lastHeaderCell||d.header},{...d.cell},{...d.firstFooterCell||d.footer},{...d.footer}]:Array(5).fill({}),{cells:u,merged:f,rowSizes:g,colSizes:p,styles:w}=G(this.getState(),r,h),m=r.cdn||"https://cdn.dhtmlx.com/libs/json2excel/1.3.2/worker.js";this.getXlsxWorker(m).then(x=>{x.onmessage=_=>{if(_.data.type=="ready"){const y=_.data.blob;r.download!==!1?D(y,c):s.result=y,i(!0)}},x.postMessage({type:"convert",data:{data:[{name:r.sheetName||"data",cells:u,cols:p,rows:g,merged:f}],styles:w}})})}else a()})),t.on("hotkey",({key:s,event:i,isInput:a})=>{switch(s){case"arrowup":{const{flatData:r,focusCell:c,select:l}=this.getState();if(i.preventDefault(),a)return;const d=c?c.column:this._getFirstVisibleColumn()?.id,h=c?this.getPrevRow(c.row)?.id:r[r.length-1]?.id;d&&h&&(this.in.exec("focus-cell",{row:h,column:d,eventSource:"key"}),l&&this.in.exec("select-row",{id:h}));break}case"arrowdown":{const{flatData:r,focusCell:c,select:l}=this.getState();if(i.preventDefault(),a)return;const d=c?c.column:this._getFirstVisibleColumn()?.id,h=c?this.getNextRow(c.row)?.id:r[0]?.id;d&&h&&(this.in.exec("focus-cell",{row:h,column:d,eventSource:"key"}),l&&this.in.exec("select-row",{id:h}));break}case"arrowright":{const{focusCell:r}=this.getState();if(a)return;if(i.preventDefault(),r){const c=this.getNextColumn(r.column,!0)?.id;c&&this.in.exec("focus-cell",{row:r.row,column:c,eventSource:"key"})}break}case"arrowleft":{const{focusCell:r}=this.getState();if(a)return;if(i.preventDefault(),r){const c=this.getPrevColumn(r.column,!0)?.id;c&&this.in.exec("focus-cell",{row:r.row,column:c,eventSource:"key"})}break}case"tab":{const{editor:r,focusCell:c,select:l}=this.getState();if(r){i.preventDefault();const d=r.column;let h=r.id,u=this.getNextEditor(this.getRow(h),this.getColumn(d));if(!u){const f=this.getNextRow(h);f&&(h=f.id,u=this.getNextEditor(f))}u&&(this.in.exec("open-editor",{id:h,column:u.id}),this.in.exec("focus-cell",{row:h,column:u.id,eventSource:"key"}),l&&!this.isSelected(h)&&this.in.exec("select-row",{id:h}))}else c&&this.in.exec("focus-cell",{eventSource:"key"});break}case"shift+tab":{const{editor:r,focusCell:c,select:l}=this.getState();if(r){i.preventDefault();const d=r.column;let h=r.id,u=this.getPrevEditor(this.getRow(h),this.getColumn(d));if(!u){const f=this.getPrevRow(h);f&&(h=f.id,u=this.getPrevEditor(f))}u&&(this.in.exec("open-editor",{id:h,column:u.id}),this.in.exec("focus-cell",{row:h,column:u.id,eventSource:"key"}),l&&!this.isSelected(h)&&this.in.exec("select-row",{id:h}))}else c&&this.in.exec("focus-cell",{eventSource:"key"});break}case"escape":{const{editor:r}=this.getState();r&&(this.in.exec("close-editor",{ignore:!0}),this.in.exec("focus-cell",{row:r.id,column:r.column,eventSource:"key"}));break}case"f2":{const{editor:r,focusCell:c}=this.getState();!r&&c&&this.in.exec("open-editor",{id:c.row,column:c.column});break}case"enter":{const{focusCell:r,tree:c}=this.getState();if(!a&&c&&r&&this.getColumn(r.column).treetoggle){const l=this.getRow(r.row);if(!l.data)return;this.in.exec(l.open?"close-row":"open-row",{id:r.row,nested:!0})}break}case"home":{const{editor:r,focusCell:c}=this.getState();if(!r&&c){i.preventDefault();const l=this._getFirstVisibleColumn()?.id;this.in.exec("focus-cell",{row:c.row,column:l,eventSource:"key"})}break}case"ctrl+home":{const{editor:r,focusCell:c,flatData:l,select:d}=this.getState();if(!r&&c){i.preventDefault();const h=l[0]?.id,u=this._getFirstVisibleColumn()?.id;h&&u&&(this.in.exec("focus-cell",{row:h,column:u,eventSource:"key"}),d&&!this.isSelected(h)&&this.in.exec("select-row",{id:h}))}break}case"end":{const{editor:r,focusCell:c}=this.getState();if(!r&&c){i.preventDefault();const l=this._getLastVisibleColumn()?.id,d=c.row;this.in.exec("focus-cell",{row:d,column:l,eventSource:"key"})}break}case"ctrl+end":{const{editor:r,focusCell:c,flatData:l,select:d}=this.getState();if(!r&&c){i.preventDefault();const h=l.at(-1).id,u=this._getLastVisibleColumn()?.id;h&&u&&(this.in.exec("focus-cell",{row:h,column:u,eventSource:"key"}),d&&!this.isSelected(h)&&this.in.exec("select-row",{id:h}))}break}case"ctrl+z":{this.in.exec("undo",{});break}case"ctrl+y":{this.in.exec("redo",{});break}}}),t.on("scroll",s=>{const{_columns:i,split:a,_sizes:r,flatData:c,dynamic:l}=this.getState();let d=-1,h=-1,u=0;if(s.column){d=0;const f=i.findIndex(g=>g.id==s.column);u=i[f].width;for(let g=a.left??0;g<f;g++){const p=i[g];p.hidden||(d+=p.width)}}if(s.row&&!l){const f=c.findIndex(g=>g.id===s.row);f>=0&&(h=r.rowHeight*f)}this.setState({scroll:{top:h,left:d,width:u,height:r.rowHeight}})}),t.on("print",s=>{const i=re(s);this.setState({_print:i}),this.setStateAsync({_print:null})}),t.on("undo",()=>{this._historyManager?.handleUndo()}),t.on("redo",()=>{this._historyManager?.handleRedo()}),this.initOnce()}getXlsxWorker(e){if(!this._xlsxWorker){const n=window.URL.createObjectURL(new Blob([`importScripts('${e}');`],{type:"text/javascript"}));this._xlsxWorker=new Promise(t=>{const s=new Worker(n);s.addEventListener("message",i=>{i.data.type==="init"&&t(s)})})}return this._xlsxWorker}initOnce(){const e={sortMarks:{},_filterIds:null,data:[],filterValues:{},scroll:null,editor:null,focusCell:null,_print:null,history:{undo:0,redo:0}};this._router.init(e)}init(e){e.hasOwnProperty("_skin")&&!e._skin&&(e._skin=xe()),e.columns&&e.columns.forEach(n=>{n.options&&(n.optionsMap=new Map(n.options.map(t=>[t.id,t.label])))}),b(this.getState().data,e.data)||(e.tree?(this._branches={0:{data:e.data}},e.data=this.normalizeTreeRows(e.data)):e.data=this.normalizeRows(e.data),this.setState({_filterIds:null,filterValues:{},sortMarks:{}}),this._historyManager&&this._historyManager.resetHistory()),A()&&(e.tree&&(e.undo=!1),e.split?.right&&(e.split.right=0)),e.undo&&!this._historyManager&&(this._historyManager=new ue(this.in,this.getState.bind(this),this.setState.bind(this))),this._router.init({...e})}setState(e,n){return this._router.setState(e,n)}setStateAsync(e){this._router.setStateAsync(e)}getRow(e){const{tree:n}=this.getState();return n?this._branches[e]:this.getState().data.find(t=>t.id==e)}getRowIndex(e,n){return n||(n=this.getState().flatData),n.findIndex(t=>t.id==e)}getNextRow(e){const n=this.getState().flatData,t=this.getRowIndex(e,n);return n[t+1]}getPrevRow(e){const n=this.getState().flatData,t=this.getRowIndex(e,n);return n[t-1]}getColumn(e){return this.getState().columns.find(n=>n.id==e)}getNextColumn(e,n){const t=this.getState()._columns,s=t.findIndex(i=>i.id==e);return n?this._getFirstVisibleColumn(s+1):t[s+1]}getPrevColumn(e,n){const t=this.getState()._columns,s=t.findIndex(i=>i.id==e);return n?this._getLastVisibleColumn(s-1):t[s-1]}_getFirstVisibleColumn(e){const n=this.getState()._columns;let t=e??0;for(;t<n.length&&(n[t]?.hidden||n[t]?.collapsed);)t++;return n[t]}_getLastVisibleColumn(e){const n=this.getState()._columns;let t=e??n.length-1;for(;t<n.length&&(n[t]?.hidden||n[t]?.collapsed);)t--;return n[t]}isCellEditable(e,n){const{editor:t,hidden:s}=n;return!t||s?!1:typeof t=="function"?t(e,n):!0}getNextEditor(e,n){let t=this.getState().columns;if(n){const s=t.findIndex(i=>i.id==n.id);t=t.slice(s+1)}return t.find(s=>this.isCellEditable(e,s))}getPrevEditor(e,n){let t=this.getState().columns;if(n){const s=t.findLastIndex(i=>i.id==n.id);t=t.slice(0,s)}return t.findLast(s=>this.isCellEditable(e,s))}toggleBranch(e,n,t){let s=this._branches[e],{data:i}=this.getState();if(i=[...i],e!==0){s={...s,open:n};const a=this.updateTreeRow(s);s.$parent===0&&(i=a)}t&&s.data?.length&&s.data.forEach(a=>{const r=this.toggleKids(a,n,t);e===0&&(i=r)}),this.setState({data:i})}toggleKids(e,n,t){e={...e,open:n};const s=this.updateTreeRow(e);return t&&e.data?.length&&e.data.forEach(i=>{this.toggleKids(i,n,t)}),s}updateTreeRow(e){const n=e.id;this._branches[n]=e;const t=this._branches[e.$parent],s=t.data.findIndex(i=>i.id==n);return t.data=[...t.data],t.data[s]=e,t.data}isSelected(e){return this.getState().selectedRows.indexOf(e)!==-1}findAndRemove(e,n){for(let t=0;t<e.length;t++){if(e[t].id==n)return e.splice(t,1)[0];if(e[t].data){const s=[...e[t].data],i=this.findAndRemove(s,n);if(i)return e[t]={...e[t],data:s},i}}return null}insertItem(e,n,t,s){for(let i=0;i<e.length;i++){if(e[i].id==n){const a=e[i],r=s==="before"?i:i+1;if(a.data){if(s==="before"){const c=i>0?e[i-1]:null;return c?.data&&c.open?e[i-1]={...c,data:[...c.data,t]}:e.splice(r,0,t),!0}else if(a.open)return e[i]={...a,data:[t,...a.data]},!0}return e.splice(r,0,t),!0}if(e[i].data&&(e[i]={...e[i],data:[...e[i].data]},this.insertItem(e[i].data,n,t,s)))return!0}return!1}moveItem(e,n,t,s){const i=[...t],a=this.findAndRemove(i,e);return this.insertItem(i,n,a,s),i}copyColumns(e){const n=[];return e.forEach(t=>{const s={...t};this.copyHeaderFooter(s,"header"),this.copyHeaderFooter(s,"footer"),n.push(s)}),n}copyHeaderFooter(e,n){let t=e[n];t=Array.isArray(t)?[...t]:[t],t.forEach((s,i)=>{t[i]=typeof s=="string"?{text:s}:{...s}}),e[n]=t}setCollapsibleColumns(e,n,t){let s=e.header;for(let i=0;i<s.length;i++){const a=s[i];if(a.collapsible&&a.collapsed){if(a.collapsible!=="first"){e.collapsed=!0,e.width=36,a.vertical=!0;const c=s.length-i;s=s.slice(0,i+1),s[i].rowspan=c}const r=a.colspan;if(r){const c=s[i+1];let l=1;c&&c.colspan&&!c.collapsed&&(l=c.colspan);for(let d=l;d<r;d++){const h=t[n+d];h&&(h.hidden=!0)}}}}}normalizeColumns(e,n,t,s,i){const a=e[n];a.width||(a.width=a.flexgrow?17:i.columnWidth),a._colindex=n+1;const r=a[t],c=i[`${t}RowHeights`];for(let l=0;l<s;l++){const d=r[l];d.id=a.id,l===r.length-1&&(d.rowspan=d.rowspan?Math.min(d.rowspan,s-l):s-l);for(let h=1;h<d.rowspan;h++){r.splice(l+h,0,{_hidden:!0});for(let u=1;u<d.colspan;u++)e[n+u][t].splice(l+h,0,{})}if(d.rowspan){const h=(d.rowspan===s?c:c.slice(l,d.rowspan+l)).reduce((u,f)=>u+f,0);d.height=h,l+d.rowspan!=s&&d.height--}if(d.colspan){let h=a.width,u=a.flexgrow||0;const f=d.colspan;for(let g=1;g<f;g++){const p=e[n+g];p&&(p.hidden?d.colspan-=1:p.flexgrow?u+=p.flexgrow:h+=p.width||i.columnWidth),u?d.flexgrow=u:d.width=h}}else d.width=a.width,d.flexgrow=a.flexgrow;t==="header"&&d.filter&&typeof d.filter=="string"&&(d.filter={type:d.filter})}r.length>s&&(r.length=s),a[t]=r}normalizeRows(e){return e.forEach(n=>{n.id||(n.id=E())}),e}normalizeTreeRows(e,n,t){return e.forEach(s=>{s.id||(s.id=E()),s.$level=n||0,s.$parent=t||0,this._branches[s.id]=s,s.data&&(s.data.length?(s.$count=s.data.length,this.normalizeTreeRows(s.data,s.$level+1,s.id)):(delete s.data,delete s.$count,delete s.open))}),e}sortTree(e,n){e.sort(n),e.forEach(t=>{t.data&&this.sortTree(t.data,n)})}filterTree(e,n,t){return e.forEach(s=>{n(s)&&t.push(s.id),s.data&&this.filterTree(s.data,n,t)}),t}flattenRows(e,n,t){const s=n;return e.forEach(i=>{(!t||t.includes(i.id))&&s.push(i),i.data?.length&&i.open!==!1&&this.flattenRows(i.data,s,t)}),s}createFilter(e){const{_columns:n}=this.getState(),t=[];for(const s in e){const{config:i,type:a}=n.find(c=>c.id==s).header.find(c=>c.filter).filter,r=e[s];t.push(c=>i?.handler?i.handler(c[s],r):be(a)(c[s],r))}return s=>{for(let i=0;i<t.length;i++)if(!t[i](s))return!1;return!0}}normalizeSizes(e,n,t,s,i){const a=L(e,"header",t,n.headerHeight,i),r=L(e,"footer",s,n.footerHeight,i),c=a.reduce((d,h)=>d+h,0),l=r.reduce((d,h)=>d+h,0);return{...n,headerRowHeights:a,footerRowHeights:r,headerHeight:c,footerHeight:l}}}let ke=new Date().valueOf();function E(){return"temp://"+ke++}function Ce(o,e="data-id"){let n=o;for(!n.tagName&&o.target&&(n=o.target);n;){if(n.getAttribute&&n.getAttribute(e))return n;n=n.parentNode}return null}new Date().valueOf();function Re(o,{keys:e,exec:n}){for(const s in e){const i=s.toLowerCase().replace(/ /g,"");i!==s&&(e[i]=e[s])}function t(s){let i=s.code.replace("Key","").toLowerCase();i===" "&&(i="space");const a=`${s.ctrlKey||s.metaKey?"ctrl+":""}${s.shiftKey?"shift+":""}${s.altKey?"alt+":""}${i.replace(/^key/,"")}`,r=e[a];if(typeof r<"u"){const c=s.target.tagName==="INPUT"||s.target.tagName==="TEXTAREA"||Ce(s.target,"data-header-id")?.classList.contains("wx-filter")||!!s.target.closest(".wx-cell.wx-editor");typeof r=="function"?r({key:a,event:s,node:o,isInput:c}):r&&n({key:a,event:s,node:o,isInput:c})}}return o.addEventListener("keydown",t),{destroy:()=>{o.removeEventListener("keydown",t)}}}function Ee(o,e){let n=null;e.scroll.subscribe(t=>{if(!t||t===n)return;n=t;const{left:s,top:i,height:a,width:r}=t,c=e.getHeight(),l=e.getWidth(),d=e.getScrollMargin();if(i>=0){const h=o.scrollTop;i<h?o.scrollTop=i:i+a>h+c&&(o.scrollTop=i-c+a)}if(s>=0){const h=o.scrollLeft;s<h?o.scrollLeft=s:s+r>h+l-d&&(o.scrollLeft=s-l+r+d)}})}const Ie=[{id:"add:before",text:"Add before",icon:"wxi-table-row-plus-before"},{id:"add:after",text:"Add after",icon:"wxi-table-row-plus-after"},{id:"copy",text:"Copy",icon:"wxi-content-copy"},{comp:"separator"},{id:"delete",text:"Delete",icon:"wxi-delete-outline"}];export{ve as DataStore,Ie as defaultMenuOptions,X as getEditorConfig,ne as getHeaderFooterPrintColumns,ae as getPrintCellStyle,se as getPrintColumns,le as getPrintFilterValue,v as getRenderValue,fe as getStamp,S as getValue,Re as hotkeys,A as isCommunity,Ee as scrollTo};
